// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id              Int              @id @default(autoincrement())
  name            String
  phone           String
  email           String           @unique
  idNumber        String           @db.Char(16)
  role            Role
  districtId      Int? // Only for DISTRICT_CPO users
  district        District?        @relation(fields: [districtId], references: [id])
  password        String?
  emailVerified   Boolean          @default(false)
  activationToken String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  disabled        Boolean          @default(false)
  directories     Directory[] // directories created by this user
  analyticsEvents AnalyticsEvent[] // analytics events for this user

  @@map("users")
}

enum Role {
  ADMIN
  ENUMERATOR
  DISTRICT_CPO
}

enum Category {
  GOVERNMENT
  NON_GOVERNMENTAL
  COMMUNITY_BASED
}

model ServiceType {
  id          Int                @id @default(autoincrement())
  name        String             @unique
  directories DirectoryService[]
}

// --- Beneficiary Type CRUD
model BeneficiaryType {
  id          Int                    @id @default(autoincrement())
  name        String                 @unique
  description String?
  directories DirectoryBeneficiary[]
}

// Junction table for Directory <-> BeneficiaryType
model DirectoryBeneficiary {
  id            Int             @id @default(autoincrement())
  directory     Directory       @relation(fields: [directoryId], references: [id])
  directoryId   Int
  beneficiary   BeneficiaryType @relation(fields: [beneficiaryId], references: [id])
  beneficiaryId Int
}

// --- Directory model
model Directory {
  id                 Int                    @id @default(autoincrement())
  nameOfOrganization String
  category           String
  email              String
  phone              String
  website            String?
  paid               Boolean                @default(false)
  otherServices      String?
  services           DirectoryService[]
  createdById        Int
  createdBy          User                   @relation(fields: [createdById], references: [id])
  locations          DirectoryLocation[] // multiple locations
  beneficiaries      DirectoryBeneficiary[] // multiple beneficiaries
  reports            Report[] // reports about this directory
}

// Junction table for Directory <-> ServiceType
model DirectoryService {
  id          Int         @id @default(autoincrement())
  directory   Directory   @relation(fields: [directoryId], references: [id])
  directoryId Int
  service     ServiceType @relation(fields: [serviceId], references: [id])
  serviceId   Int
}

// --- Junction table for Directory <-> Location
model DirectoryLocation {
  id          Int       @id @default(autoincrement())
  directory   Directory @relation(fields: [directoryId], references: [id])
  directoryId Int
  district    District  @relation(fields: [districtId], references: [id])
  districtId  Int
  sector      Sector    @relation(fields: [sectorId], references: [id])
  sectorId    Int
  cell        Cell      @relation(fields: [cellId], references: [id])
  cellId      Int
  village     Village   @relation(fields: [villageId], references: [id])
  villageId   Int
}

model District {
  id          Int                 @id @default(autoincrement())
  name        String              @unique
  sectors     Sector[]
  directories DirectoryLocation[]
  users       User[] // Users assigned to this district (DISTRICT_CPO)
}

model Sector {
  id          Int                 @id @default(autoincrement())
  name        String
  district    District            @relation(fields: [districtId], references: [id])
  districtId  Int
  cells       Cell[]
  directories DirectoryLocation[]
}

model Cell {
  id          Int                 @id @default(autoincrement())
  name        String
  sector      Sector              @relation(fields: [sectorId], references: [id])
  sectorId    Int
  villages    Village[]
  directories DirectoryLocation[]
}

model Village {
  id          Int                 @id @default(autoincrement())
  name        String
  cell        Cell                @relation(fields: [cellId], references: [id])
  cellId      Int
  directories DirectoryLocation[]
}

enum ReportType {
  NON_FUNCTIONAL
  INACTIVE_SERVICE
  INCORRECT_INFO
  OTHER
}

model Report {
  id            Int        @id @default(autoincrement())
  directoryId   Int
  directory     Directory  @relation(fields: [directoryId], references: [id], onDelete: Cascade)
  reportType    ReportType
  description   String
  reporterName  String?
  reporterEmail String?
  reporterPhone String?
  status        String     @default("PENDING") // PENDING, REVIEWED, RESOLVED
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@map("reports")
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  eventType String
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([timestamp])
  @@index([eventType])
  @@index([userId])
  @@map("analytics_events")
}
